<?xml version="1.0" encoding="UTF-8" ?>    
<!DOCTYPE mapper    
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"    
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="EPass">
	<insert id="submitEPass" parameterType="EPass">
		INSERT INTO EPASS
		(USER_ID, SURVEY_ID, IS_ALLOWED, TO_DATE, CREATED_BY,FROM_DATE)
		VALUES
		(#{user.userId}, #{survey.surveyId}, #{isAllowed}, #{toDate,
		javaType=java.time.LocalDate}, #{createdBy.userId},#{fromDate,	javaType=java.time.LocalDate});
	</insert>
	
	<select id ="searchEPass" parameterType="EPass" resultMap="EPass-ResultMappings.ResultSearchEPass">
		SELECT 
			e.user_id, 
			e.survey_id, 
			e.is_allowed, 
			e.to_date, 
			e.created_by, 
			e.created_on,
			e.from_date 
		FROM epass e 
		INNER JOIN (
			SELECT user_id, 
			Max(created_on) AS latestDate 
			FROM   epass 
			WHERE  survey_id = #{survey.surveyId} 
			<if test="user.userId != null">
				AND user_id = #{user.userId} 
			</if>
			<if test="user.mgrID != null">
				AND user_id in (select user_id from user where mgr_id = #{user.userId}) 
			</if>
			GROUP  BY user_id
			) etemp 
		ON ( e.user_id = etemp.user_id ) 
		AND e.created_on = etemp.latestdate; 
	</select>
</mapper>