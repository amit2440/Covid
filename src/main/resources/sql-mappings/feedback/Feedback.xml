<?xml version="1.0" encoding="UTF-8" ?>    
<!DOCTYPE mapper    
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"    
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace = "Feedback">
	<delete id="deleteFeedback" parameterType="Feedback">
		DELETE FROM covid.feedback WHERE user_id = #{user.userId};
	</delete>
	<insert id="insertFeedback" parameterType="Feedback">
		<selectKey keyProperty="surveyQuestion.ssqId" resultType="int" order="BEFORE">
			SELECT ssq_id FROM survey_question WHERE survey_id=#{surveyQuestion.survey.surveyId} AND question_id=#{surveyQuestion.question.questionId};
		</selectKey>
		INSERT into feedback (<include refid="Feedback-SqlQueries.InsertForSubmitFeedback"/>)
		VALUES(#{user.userId}, #{surveyQuestion.ssqId}, #{option.optionId}, #{value})
	</insert>

	<select id ="selectFeedbacksForSurveyAndUser" parameterType="Feedback" resultMap="Feedback-ResultMappings.ResultForGetFeedbackForSurveyAndUser">
		SELECT f.user_id, f.value,sq.survey_id, q.question, o.display_name, o.risk, o.type
		FROM covid.feedback f
		JOIN covid.user u
		ON u.user_id = f.user_id
		JOIN covid.survey_question sq
		ON sq.ssq_Id = f.ssq_id
		JOIN covid.survey s
		ON s.survey_id = sq.survey_id
		JOIN covid.question q
		ON sq.question_id = q.question_id
		JOIN covid.option o
		ON f.option_id = o.option_id
		WHERE u.user_id =#{user.userId} AND u.is_active=1
		AND sq.survey_id =#{surveyQuestion.survey.surveyId}
		AND s.is_active=1
	</select>
	<select id ="selectFeedbacksForSurvey" parameterType="Feedback" resultMap="Feedback-ResultMappings.ResultForGetFeedbackForSurvey">
		SELECT f.value,sq.survey_id, q.question, o.display_name, o.risk, o.type
		FROM covid.feedback f
		JOIN covid.survey_question sq
		ON sq.ssq_Id = f.ssq_id
		JOIN covid.survey s
		ON s.survey_id = sq.survey_id
		JOIN covid.question q
		ON sq.question_id = q.question_id
		JOIN covid.option o
		ON f.option_id = o.option_id
		WHERE sq.survey_id =#{surveyQuestion.survey.surveyId} AND s.is_active=1
	</select>
</mapper>